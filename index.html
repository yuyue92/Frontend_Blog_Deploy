<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yy3ä¸ªäººåšå®¢ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== å…¨å±€ Loadingï¼ˆè§£å†³åˆ‡é¡µ/è¯¦æƒ…æ¸²æŸ“å»¶è¿Ÿï¼‰ ===== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-card {
            width: 260px;
            padding: 18px 16px;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.10);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(24, 144, 255, 0.20);
            border-top-color: #1890ff;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 13px;
            color: #333;
        }

        /* é¡¶éƒ¨æ  */
        .topbar {
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
        }

        .topbar h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            height: calc(100vh - 50px);
        }

        /* å·¦ä¾§èœå• */
        .sidebar {
            width: 200px;
            background: #001529;
            color: white;
            overflow-y: auto;
        }

        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .menu-item.active {
            background: #1890ff;
            border-left-color: #40a9ff;
        }

        .menu-item.disabled {
            opacity: 0.45;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Toast æ¶ˆæ¯ï¼ˆæ›¿ä»£é¡¶éƒ¨çŠ¶æ€æ¡æç¤ºï¼‰ */
        .toast-container {
            position: fixed;
            top: 14px;
            right: 14px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: min(360px, calc(100vw - 28px));
        }

        .toast {
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: toast-in 0.18s ease-out;
        }

        @keyframes toast-in {
            from {
                transform: translateY(-6px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast .dot {
            width: 10px;
            height: 10px;
            margin-top: 4px;
            border-radius: 50%;
            background: #1890ff;
            flex: 0 0 auto;
        }

        .toast.success .dot {
            background: #52c41a;
        }

        .toast.error .dot {
            background: #ff4d4f;
        }

        .toast.info .dot {
            background: #1890ff;
        }

        .toast .content {
            font-size: 13px;
            line-height: 1.5;
            word-break: break-word;
        }

        .toast .close {
            margin-left: auto;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.75);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0 2px;
        }

        .toast .close:hover {
            color: #fff;
        }

        /* å³ä¾§å†…å®¹åŒº */
        .content-area {
            flex: 1;
            background: #fff;
            margin: 12px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            padding: 20px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .btn-danger:hover {
            background: #ff7875;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 12px;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid #d9d9d9;
            color: #333;
        }

        .btn-ghost:hover {
            border-color: #1890ff;
            color: #1890ff;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* æç¤ºæ¡† */
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .alert-error {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .page-header h2 {
            font-size: 18px;
            color: #333;
        }

        .page-subtitle {
            color: #8c8c8c;
            font-size: 12px;
            margin-top: 2px;
        }

        .back-btn {
            margin-bottom: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8c8c8c;
            font-size: 13px;
        }

        /* é…ç½®åŒºåŸŸ */
        .config-section {
            background: #fafafa;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            border: 1px solid #f0f0f0;
        }

        .config-section h3 {
            margin-bottom: 12px;
            color: #333;
            font-size: 15px;
        }

        .test-results {
            margin-top: 16px;
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #f0f0f0;
        }

        .test-item {
            padding: 6px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .test-success {
            background: #f6ffed;
            color: #52c41a;
        }

        .test-error {
            background: #fff2f0;
            color: #ff4d4f;
        }

        .hidden {
            display: none !important;
        }

        /* ===== é¦–é¡µ/åˆ—è¡¨ï¼šæ›´ç´§å‡‘ç»“æ„ + è¯„è®ºæ•° + åˆ†é¡µ ===== */
        .list-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .list-toolbar .left {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .list-toolbar .right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .muted {
            color: #8c8c8c;
            font-size: 12px;
        }

        .post-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .post-card {
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            padding: 12px 14px;
            transition: all 0.2s;
            background: #fff;
        }

        .post-card:hover {
            border-color: rgba(24, 144, 255, 0.55);
            box-shadow: 0 2px 10px rgba(24, 144, 255, 0.12);
        }

        .post-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }

        .post-title {
            color: #333;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.35;
            margin: 0;
        }

        .post-title:hover {
            color: #1890ff;
        }

        .post-meta {
            color: #8c8c8c;
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .post-content {
            color: #555;
            line-height: 1.65;
            margin-top: 8px;
            font-size: 13px;
        }

        .post-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #f0f0f0;
            background: #fafafa;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .page-btn {
            min-width: 34px;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid #d9d9d9;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover {
            border-color: #1890ff;
            color: #1890ff;
        }

        .page-btn.active {
            border-color: #1890ff;
            background: #1890ff;
            color: #fff;
        }

        .page-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* è¯„è®ºå¡ç‰‡ */
        .comment-card {
            background: #fafafa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #1890ff;
        }

        .comment-meta {
            color: #8c8c8c;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
            font-size: 13px;
            white-space: pre-wrap;
        }

        /* è¯¦æƒ…é¡µæ ·å¼ */
        .post-detail-header {
            margin-bottom: 16px;
        }

        .post-detail-header h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 8px;
        }

        .comments-section {
            margin-top: 26px;
            padding-top: 18px;
            border-top: 1px solid #f0f0f0;
        }

        .comments-section h3 {
            font-size: 16px;
            margin-bottom: 14px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                width: 160px;
            }

            .topbar h1 {
                font-size: 16px;
            }

            .content-area {
                margin: 8px;
                padding: 12px;
            }

            .post-head {
                flex-direction: column;
                align-items: stretch;
            }

            .post-actions {
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <!-- å…¨å±€ Loading -->
    <div id="globalLoading" class="loading-overlay hidden" aria-live="polite" aria-busy="true">
        <div class="loading-card">
            <div class="spinner" aria-hidden="true"></div>
            <div class="loading-text" id="loadingText">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- é¡¶éƒ¨æ  -->
    <div class="topbar">
        <h1>ğŸš€ ä¸ªäººåšå®¢ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="user-info">
            <span id="userDisplay"></span>
            <button id="logoutBtn" class="btn btn-secondary btn-small hidden">é€€å‡º</button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§èœå• -->
        <div class="sidebar">
            <div class="menu-item active" data-page="home">ğŸ“š é¦–é¡µ</div>
            <div class="menu-item" data-page="login" id="menuLogin">ğŸ” ç™»å½•</div>
            <div class="menu-item" data-page="register" id="menuRegister">ğŸ“ æ³¨å†Œ</div>
            <div class="menu-item" data-page="myPosts" id="menuMyPosts">ğŸ“– æˆ‘çš„æ–‡ç« </div>
            <div class="menu-item" data-page="createPost" id="menuCreatePost">âœï¸ å‘å¸ƒæ–‡ç« </div>
            <div class="menu-item" data-page="test">ğŸ§ª APIæµ‹è¯•</div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="content-area">
            <div id="toastContainer" class="toast-container"></div>

            <!-- é¦–é¡µ -->
            <div id="homePage" class="page">
                <div class="page-header">
                    <div>
                        <h2>æœ€æ–°æ–‡ç« </h2>
                        <div class="page-subtitle" id="homeSubTitle">â€”</div>
                    </div>
                    <div class="right">
                        <button class="btn btn-ghost btn-small" onclick="app.refreshHome()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="list-toolbar">
                    <div class="left">
                        <span class="muted" id="homeCount">å…± 0 ç¯‡</span>
                    </div>
                    <div class="right">
                        <span class="muted">æ¯é¡µ</span>
                        <select id="homePageSize" onchange="app.setPageSize('home', this.value)"
                            style="padding:6px 10px;border:1px solid #d9d9d9;border-radius:6px;font-size:12px;">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
                <div id="postsList" class="post-list"></div>
                <div id="homePagination" class="pagination"></div>
            </div>

            <!-- ç™»å½•é¡µ -->
            <div id="loginPage" class="page hidden">
                <div class="page-header">
                    <h2>ç”¨æˆ·ç™»å½•</h2>
                    <div class="right"></div>
                </div>
                <form id="loginForm" style="max-width: 400px;">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="loginPassword" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary">ç™»å½•</button>
                </form>
            </div>

            <!-- æ³¨å†Œé¡µ -->
            <div id="registerPage" class="page hidden">
                <div class="page-header">
                    <h2>ç”¨æˆ·æ³¨å†Œ</h2>
                    <div class="right"></div>
                </div>
                <form id="registerForm" style="max-width: 400px;">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="regUsername" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>é‚®ç®±</label>
                        <input type="email" id="regEmail" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="regPassword" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn btn-primary">æ³¨å†Œå¹¶è‡ªåŠ¨ç™»å½•</button>
                </form>
            </div>

            <!-- æˆ‘çš„æ–‡ç«  -->
            <div id="myPostsPage" class="page hidden">
                <div class="page-header">
                    <div>
                        <h2>æˆ‘çš„æ–‡ç« </h2>
                        <div class="page-subtitle" id="mySubTitle">â€”</div>
                    </div>
                    <div class="right">
                        <button class="btn btn-ghost btn-small" onclick="app.refreshMyPosts()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                <div class="list-toolbar">
                    <div class="left">
                        <span class="muted" id="myCount">å…± 0 ç¯‡</span>
                    </div>
                    <div class="right">
                        <span class="muted">æ¯é¡µ</span>
                        <select id="myPageSize" onchange="app.setPageSize('my', this.value)"
                            style="padding:6px 10px;border:1px solid #d9d9d9;border-radius:6px;font-size:12px;">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
                <div id="myPostsList" class="post-list"></div>
                <div id="myPagination" class="pagination"></div>
            </div>

            <!-- å‘å¸ƒæ–‡ç«  -->
            <div id="createPostPage" class="page hidden">
                <div class="page-header">
                    <h2>å‘å¸ƒæ–‡ç« </h2>
                    <div class="right"></div>
                </div>
                <form id="createPostForm" style="max-width: 800px;">
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <input type="text" id="postTitle" required>
                    </div>
                    <div class="form-group">
                        <label>å†…å®¹</label>
                        <textarea id="postContent" required rows="24"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">å‘å¸ƒ</button>
                </form>
            </div>

            <!-- æ–‡ç« è¯¦æƒ… -->
            <div id="postDetailPage" class="page hidden">
                <button class="btn btn-secondary back-btn" onclick="app.backFromDetail()">â† è¿”å›</button>
                <div id="postDetail"></div>
                <div class="comments-section">
                    <h3>ğŸ’¬ è¯„è®ºåŒº</h3>
                    <form id="commentForm" class="hidden" style="margin-bottom: 16px;">
                        <div class="form-group">
                            <textarea id="commentContent" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
                    </form>
                    <div id="commentsList"></div>
                </div>
            </div>

            <!-- ç¼–è¾‘æ–‡ç«  -->
            <div id="editPostPage" class="page hidden">
                <button class="btn btn-secondary back-btn" onclick="app.showPage('myPosts')">â† è¿”å›</button>
                <div class="page-header">
                    <h2>ç¼–è¾‘æ–‡ç« </h2>
                    <div class="right"></div>
                </div>
                <form id="editPostForm" style="max-width: 800px;">
                    <input type="hidden" id="editPostId">
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <input type="text" id="editPostTitle" required>
                    </div>
                    <div class="form-group">
                        <label>å†…å®¹</label>
                        <textarea id="editPostContent" required rows="24"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                </form>
            </div>

            <!-- APIæµ‹è¯• -->
            <div id="testPage" class="page hidden">
                <div class="page-header">
                    <h2>APIæµ‹è¯•ä¸­å¿ƒ</h2>
                    <div class="right"></div>
                </div>

                <div class="config-section">
                    <h3>âš™ï¸ é…ç½®</h3>
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="apiBaseUrl" value="http://localhost:8080/api/v1">
                    </div>
                    <button class="btn btn-primary" onclick="app.saveConfig()">ä¿å­˜é…ç½®</button>
                </div>

                <div class="config-section">
                    <h3>ğŸ” æµ‹è¯•é€‰é¡¹</h3>
                    <button class="btn btn-success" onclick="app.runAllTests()">è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
                    <button class="btn btn-primary" onclick="app.testHealth()">å¥åº·æ£€æŸ¥</button>
                    <button class="btn btn-primary" onclick="app.testAuth()">æµ‹è¯•è®¤è¯</button>
                    <button class="btn btn-primary" onclick="app.testPosts()">æµ‹è¯•æ–‡ç« </button>
                    <button class="btn btn-primary" onclick="app.testComments()">æµ‹è¯•è¯„è®º</button>
                    <button class="btn btn-danger" onclick="app.clearTestResults()">æ¸…é™¤ç»“æœ</button>
                </div>

                <div class="test-results" id="testResults">
                    <p style="color: #8c8c8c;">æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        var app = {
            // apiBase: 'http://localhost:8080/api/v1',
            apiBase: 'https://railwaygolangblogsupabase-production.up.railway.app/api/v1',
            token: localStorage.getItem('token') || '',
            user: null,
            currentPost: null,
            lastListPage: 'home',

            // åˆ—è¡¨æ•°æ®ä¸åˆ†é¡µï¼ˆå‰ç«¯åˆ†é¡µï¼šå…¼å®¹åç«¯ä¸æ”¯æŒåˆ†é¡µçš„åœºæ™¯ï¼‰
            state: {
                home: { all: [], page: 1, pageSize: 10, total: 0, totalPage: 1 },
                my: { all: [], page: 1, pageSize: 10, total: 0, totalPage: 1 }
            },

            // å…¨å±€ loading è®¡æ•°ï¼ˆé¿å…å¹¶å‘è¯·æ±‚é—ªçƒï¼‰
            _loadingCount: 0,

            init: function () {
                this.loadConfig();
                this.bindEvents();
                this.updateAuthMenus();

                if (this.token) {
                    this.fetchProfile();
                }

                this.fetchPosts({ silent: false });
            },

            /* ===== å·¥å…·æ–¹æ³• ===== */
            setLoading: function (on, text) {
                var overlay = document.getElementById('globalLoading');
                var textEl = document.getElementById('loadingText');
                if (on) {
                    this._loadingCount += 1;
                    if (text) textEl.textContent = text;
                    overlay.classList.remove('hidden');
                } else {
                    this._loadingCount = Math.max(0, this._loadingCount - 1);
                    if (this._loadingCount === 0) {
                        overlay.classList.add('hidden');
                        textEl.textContent = 'åŠ è½½ä¸­...';
                    }
                }
            },

            requestJson: function (url, options, loadingText) {
                var self = this;
                options = options || {};
                if (loadingText) self.setLoading(true, loadingText);

                return fetch(url, options)
                    .then(function (res) { return res.json(); })
                    .finally(function () {
                        if (loadingText) self.setLoading(false);
                    });
            },

            escapeHtml: function (s) {
                if (s === null || s === undefined) return '';
                return String(s)
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#039;');
            },

            formatTime: function (iso) {
                try {
                    return new Date(iso).toLocaleString('zh-CN');
                } catch (e) {
                    return iso || '';
                }
            },

            /* ===== é…ç½® ===== */
            loadConfig: function () {
                var saved = localStorage.getItem('apiBase');
                if (saved) {
                    this.apiBase = saved;
                    document.getElementById('apiBaseUrl').value = saved;
                }
            },

            saveConfig: function () {
                this.apiBase = document.getElementById('apiBaseUrl').value;
                localStorage.setItem('apiBase', this.apiBase);
                this.showAlert('success', 'é…ç½®å·²ä¿å­˜');
            },

            /* ===== äº‹ä»¶ç»‘å®š ===== */
            bindEvents: function () {
                var self = this;

                document.querySelectorAll('.menu-item').forEach(function (item) {
                    item.addEventListener('click', function (e) {
                        var page = e.currentTarget.dataset.page;
                        self.showPage(page);
                    });
                });

                document.getElementById('loginForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleLogin();
                });

                document.getElementById('registerForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleRegisterAutoLogin();
                });

                document.getElementById('createPostForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleCreatePost();
                });

                document.getElementById('editPostForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleUpdatePost();
                });

                document.getElementById('commentForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleCreateComment();
                });

                document.getElementById('logoutBtn').addEventListener('click', function () {
                    self.handleLogout();
                });
            },

            /* ===== é¡µé¢åˆ‡æ¢ ===== */
            showPage: function (page) {
                // æœªç™»å½•æ—¶ï¼šç¦ç”¨éœ€è¦ç™»å½•çš„é¡µé¢ï¼Œå¹¶åœç•™åœ¨ç™»å½•é¡µ
                var protectedPages = ['home', 'myPosts', 'createPost', 'test'];
                if (!this.token && protectedPages.indexOf(page) !== -1) {
                    this.showToast('error', 'è¯·å…ˆç™»å½•');
                    page = 'login';
                }
                // åŸºç¡€åˆ‡é¡µï¼šä¸åš asyncï¼Œé¿å…æŠŠæ—§å†…å®¹ç•™åœ¨é¡µé¢ä¸Šå¤ªä¹…
                document.querySelectorAll('.page').forEach(function (p) {
                    p.classList.add('hidden');
                });
                document.querySelectorAll('.menu-item').forEach(function (m) {
                    m.classList.remove('active');
                });

                var pageMap = {
                    'home': 'homePage',
                    'login': 'loginPage',
                    'register': 'registerPage',
                    'myPosts': 'myPostsPage',
                    'createPost': 'createPostPage',
                    'test': 'testPage'
                };

                var pageId = pageMap[page];
                if (pageId) {
                    document.getElementById(pageId).classList.remove('hidden');
                    var menuItem = document.querySelector('[data-page="' + page + '"]');
                    if (menuItem) menuItem.classList.add('active');
                }

                if (page === 'myPosts') {
                    this.lastListPage = 'myPosts';
                    // åŒæ­¥é€‰æ‹©å™¨çš„å€¼
                    var myPageSizeSelect = document.getElementById('myPageSize');
                    if (myPageSizeSelect) {
                        myPageSizeSelect.value = this.state.my.pageSize || 10;
                    }
                    this.fetchMyPosts({ silent: false });
                } else if (page === 'home') {
                    this.lastListPage = 'home';
                    // åŒæ­¥é€‰æ‹©å™¨çš„å€¼
                    var homePageSizeSelect = document.getElementById('homePageSize');
                    if (homePageSizeSelect) {
                        homePageSizeSelect.value = this.state.home.pageSize || 10;
                    }
                    this.fetchPosts({ silent: false });
                }
            },

            backFromDetail: function () {
                // è¿”å›åˆ°è¿›å…¥è¯¦æƒ…å‰çš„åˆ—è¡¨é¡µé¢
                if (this.lastListPage === 'myPosts') this.showPage('myPosts');
                else this.showPage('home');
            },

            showAlert: function (type, message) {
                // å…¼å®¹æ—§è°ƒç”¨ï¼šç»Ÿä¸€èµ° Toast å¼¹æ¡†
                this.showToast(type, message);
            },

            showToast: function (type, message) {
                var container = document.getElementById('toastContainer');
                if (!container) return;

                var toast = document.createElement('div');
                toast.className = 'toast ' + (type || 'info');

                var dot = document.createElement('div');
                dot.className = 'dot';

                var content = document.createElement('div');
                content.className = 'content';
                content.textContent = message || '';

                var close = document.createElement('button');
                close.className = 'close';
                close.setAttribute('aria-label', 'å…³é—­');
                close.innerHTML = 'Ã—';
                close.onclick = function () {
                    if (toast && toast.parentNode) toast.parentNode.removeChild(toast);
                };

                toast.appendChild(dot);
                toast.appendChild(content);
                toast.appendChild(close);

                container.appendChild(toast);

                setTimeout(function () {
                    if (toast && toast.parentNode) toast.parentNode.removeChild(toast);
                }, 3200);
            },

            updateAuthMenus: function () {
                // ç™»å½•åï¼šéšè—â€œç™»å½•/æ³¨å†Œâ€ï¼›æœªç™»å½•ï¼šç¦ç”¨éœ€è¦ç™»å½•çš„é¡µé¢å…¥å£å¹¶åœç•™åœ¨ç™»å½•é¡µ
                var isAuthed = !!this.token;
                var mLogin = document.getElementById('menuLogin');
                var mReg = document.getElementById('menuRegister');

                var protectedPages = ['home', 'myPosts', 'createPost', 'test'];

                // å¤„ç†èœå•ç¦ç”¨æ€
                protectedPages.forEach(function (p) {
                    var item = document.querySelector('[data-page="' + p + '"]');
                    if (!item) return;
                    if (isAuthed) item.classList.remove('disabled');
                    else item.classList.add('disabled');
                });

                if (isAuthed) {
                    mLogin.classList.add('hidden');
                    mReg.classList.add('hidden');
                } else {
                    mLogin.classList.remove('hidden');
                    mReg.classList.remove('hidden');
                }
            },

            updateUserDisplay: function () {
                var display = document.getElementById('userDisplay');
                var logoutBtn = document.getElementById('logoutBtn');

                if (this.user) {
                    display.textContent = 'ğŸ‘¤ ' + this.user.username;
                    logoutBtn.classList.remove('hidden');
                } else {
                    display.textContent = '';
                    logoutBtn.classList.add('hidden');
                }
            },

            /* ===== è®¤è¯ ===== */
            fetchProfile: function () {
                var self = this;
                return this.requestJson(this.apiBase + '/profile', {
                    headers: { 'Authorization': 'Bearer ' + this.token }
                }, 'æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...')
                    .then(function (data) {
                        if (data.code === 200) {
                            self.user = data.data;
                            self.updateUserDisplay();
                            self.updateAuthMenus();
                        } else {
                            self.handleLogout(true);
                        }
                    })
                    .catch(function (err) {
                        console.error('Fetch profile error:', err);
                    });
            },

            handleLogin: function () {
                var self = this;
                var username = document.getElementById('loginUsername').value;
                var password = document.getElementById('loginPassword').value;

                this.requestJson(this.apiBase + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                }, 'æ­£åœ¨ç™»å½•...')
                    .then(function (data) {
                        if (data.code === 200 && data.data && data.data.token) {
                            self.token = data.data.token;
                            localStorage.setItem('token', self.token);
                            return self.fetchProfile().then(function () {
                                self.showAlert('success', 'ç™»å½•æˆåŠŸ!');
                                self.showPage('home');
                                document.getElementById('loginForm').reset();
                            });
                        } else {
                            self.showAlert('error', data.message || 'ç™»å½•å¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'ç™»å½•è¯·æ±‚å¤±è´¥');
                    });
            },

            // âœ… æ³¨å†Œå®Œæˆåè‡ªåŠ¨ç™»å½•ï¼ˆä¸éœ€è¦åˆ‡æ¢èœå•å†æ‰‹åŠ¨ç™»å½•ï¼‰
            handleRegisterAutoLogin: function () {
                var self = this;
                var username = document.getElementById('regUsername').value;
                var email = document.getElementById('regEmail').value;
                var password = document.getElementById('regPassword').value;

                this.requestJson(this.apiBase + '/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, email: email, password: password })
                }, 'æ­£åœ¨æ³¨å†Œ...')
                    .then(function (data) {
                        if (data.code === 200) {
                            // æ³¨å†ŒæˆåŠŸåç«‹åˆ»ç™»å½•
                            return self.requestJson(self.apiBase + '/auth/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ username: username, password: password })
                            }, 'æ­£åœ¨è‡ªåŠ¨ç™»å½•...')
                                .then(function (loginData) {
                                    if (loginData.code === 200 && loginData.data && loginData.data.token) {
                                        self.token = loginData.data.token;
                                        localStorage.setItem('token', self.token);
                                        document.getElementById('registerForm').reset();
                                        return self.fetchProfile().then(function () {
                                            self.showAlert('success', 'æ³¨å†ŒæˆåŠŸï¼Œå·²è‡ªåŠ¨ç™»å½•!');
                                            self.showPage('home');
                                        });
                                    } else {
                                        self.showAlert('success', 'æ³¨å†ŒæˆåŠŸ!ï¼ˆè‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç™»å½•ï¼‰');
                                        self.showPage('login');
                                    }
                                });
                        } else {
                            self.showAlert('error', data.message || 'æ³¨å†Œå¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'æ³¨å†Œè¯·æ±‚å¤±è´¥');
                    });
            },

            handleLogout: function (silent) {
                this.token = '';
                this.user = null;
                this.currentPost = null;
                localStorage.removeItem('token');
                this.updateUserDisplay();
                this.updateAuthMenus();
                if (!silent) this.showAlert('success', 'å·²é€€å‡ºç™»å½•');
                this.showPage('login');
            },

            /* ===== åˆ—è¡¨ï¼šæ–‡ç«  + åˆ†é¡µ + è¯„è®ºæ•° ===== */
            setPageSize: function (which, size) {
                size = parseInt(size, 10) || 10;
                if (which === 'home') {
                    this.state.home.pageSize = size;
                    this.state.home.page = 1;   // åˆ‡æ¢æ¯é¡µæ¡æ•°æ—¶å›åˆ°ç¬¬ä¸€é¡µ
                    this.fetchPosts({ silent: false });  // é‡æ–°è¯·æ±‚åç«¯
                } else {
                    this.state.my.pageSize = size;
                    this.state.my.page = 1;
                    this.fetchMyPosts({ silent: false });  // â­ å…³é”®ä¿®å¤ï¼šæ”¹ä¸ºè¯·æ±‚åç«¯
                }
            },

            refreshHome: function () {
                this.fetchPosts({ silent: false, force: true });
            },

            refreshMyPosts: function () {
                this.fetchMyPosts({ silent: false, force: true });
            },

            fetchPosts: function (opt) {
                var self = this;
                opt = opt || {};
                var container = document.getElementById('postsList');
                container.innerHTML = '<div class="empty-state"><div style="font-size: 38px;">â³</div><p>æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...</p></div>';

                // ä½¿ç”¨åç«¯åˆ†é¡µå‚æ•°
                var page = self.state.home.page || 1;
                var pageSize = self.state.home.pageSize || 8;

                var url = this.apiBase + '/posts?page=' + page + '&page_size=' + pageSize;

                return this.requestJson(url, {}, opt.silent ? null : 'æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...')
                    .then(function (data) {
                        if (data.code === 200) {
                            var posts = (data.data && data.data.posts) ? data.data.posts : [];
                            var pagination = data.data.pagination || {};

                            self.state.home.all = posts;
                            self.state.home.total = pagination.total || 0;
                            self.state.home.page = pagination.page || 1;
                            self.state.home.pageSize = pageSize; // ä»¥å‰ç«¯ä¸ºå‡†
                            self.state.home.totalPage = pagination.total_page || 1;

                            document.getElementById('homeCount').textContent =
                                'å…± ' + self.state.home.total + ' ç¯‡';

                            document.getElementById('homeSubTitle').textContent =
                                self.state.home.total ? ('ç¬¬ ' + self.state.home.page + ' é¡µ') : 'æš‚æ— å†…å®¹';

                            self.renderList('home');
                            self.updateCommentBadgesForList('home');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥');
                    });
            },

            fetchMyPosts: function (opt) {
                var self = this;
                opt = opt || {};
                var container = document.getElementById('myPostsList');

                if (!this.token) {
                    this.showAlert('error', 'è¯·å…ˆç™»å½•');
                    container.innerHTML = '<div class="empty-state"><div style="font-size: 38px;">ğŸ”</div><p>è¯·å…ˆç™»å½•åæŸ¥çœ‹æˆ‘çš„æ–‡ç« </p></div>';
                    return Promise.resolve();
                }

                container.innerHTML = '<div class="empty-state"><div style="font-size: 38px;">â³</div><p>æ­£åœ¨åŠ è½½æˆ‘çš„æ–‡ç« ...</p></div>';

                var page = self.state.my.page || 1;
                var pageSize = self.state.my.pageSize || 10;
                // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥é€’å½’è·å–æ‰€æœ‰æ–‡ç« 
                function fetchAllPosts(currentPage, allPosts) {
                    var fetchPageSize = 100; // æ¯æ¬¡è¯·æ±‚100æ¡ï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°
                    return self.requestJson(self.apiBase + '/posts?page=' + currentPage + '&page_size=' + fetchPageSize, {
                        headers: { 'Authorization': 'Bearer ' + self.token }
                    }, null)
                        .then(function (data) {
                            if (data.code === 200 && data.data && data.data.posts) {
                                var posts = data.data.posts;
                                allPosts = allPosts.concat(posts);

                                var pagination = data.data.pagination || {};
                                // å¦‚æœè¿˜æœ‰æ›´å¤šé¡µï¼Œç»§ç»­è¯·æ±‚
                                if (currentPage < (pagination.total_page || 1)) {
                                    return fetchAllPosts(currentPage + 1, allPosts);
                                } else {
                                    return allPosts;
                                }
                            } else {
                                return allPosts;
                            }
                        });
                }

                // ä»ç¬¬ä¸€é¡µå¼€å§‹è·å–æ‰€æœ‰æ–‡ç« 
                return fetchAllPosts(1, [])
                    .then(function (allPosts) {
                        // è¿‡æ»¤å‡ºå½“å‰ç”¨æˆ·çš„æ‰€æœ‰æ–‡ç« 
                        var allMyPosts = allPosts.filter(function (post) {
                            return self.user && post.user_id === self.user.id;
                        });
                        // è®¡ç®—æ€»æ•°å’Œæ€»é¡µæ•°
                        var myTotal = allMyPosts.length;
                        var myTotalPages = Math.ceil(myTotal / pageSize) || 1;

                        // ç¡®ä¿å½“å‰é¡µä¸è¶…è¿‡æ€»é¡µæ•°
                        if (page > myTotalPages) {
                            page = myTotalPages;
                            self.state.my.page = page;
                        }

                        // å‰ç«¯åˆ†é¡µï¼šä»æ‰€æœ‰æˆ‘çš„æ–‡ç« ä¸­æˆªå–å½“å‰é¡µ
                        var startIndex = (page - 1) * pageSize;
                        var endIndex = startIndex + pageSize;
                        var myPostsCurrentPage = allMyPosts.slice(startIndex, endIndex);

                        self.state.my.all = myPostsCurrentPage;
                        self.state.my.total = myTotal;
                        self.state.my.page = page;
                        self.state.my.pageSize = pageSize;
                        self.state.my.totalPage = myTotalPages;

                        document.getElementById('myCount').textContent = 'å…± ' + myTotal + ' ç¯‡';
                        document.getElementById('mySubTitle').textContent = myTotal ? ('ç¬¬ ' + page + ' / ' + myTotalPages + ' é¡µ') : 'æš‚æ— å†…å®¹';

                        self.renderList('my');
                        self.updateCommentBadgesForList('my');
                    }).catch(function (err) {
                        console.error('fetchMyPosts error:', err);
                        self.showAlert('error', 'è·å–æˆ‘çš„æ–‡ç« å¤±è´¥');
                    });
            },

            renderList: function (which) {
                var self = this;
                var st = (which === 'home') ? this.state.home : this.state.my;
                var containerId = (which === 'home') ? 'postsList' : 'myPostsList';
                var pagerId = (which === 'home') ? 'homePagination' : 'myPagination';

                var container = document.getElementById(containerId);
                var pager = document.getElementById(pagerId);

                var posts = st.all || [];
                if (!posts.length) {
                    container.innerHTML = '<div class="empty-state"><div style="font-size: 40px;">ğŸ“­</div><p>æš‚æ— æ–‡ç« </p></div>';
                    pager.innerHTML = '';
                    return;
                }

                var totalPages = st.totalPage || 1;
                st.page = Math.min(Math.max(1, st.page), totalPages);

                var slice = posts; // åç«¯å·²åˆ†é¡µï¼Œç›´æ¥ä½¿ç”¨å½“å‰é¡µæ•°æ®

                container.innerHTML = slice.map(function (post, postIndex) {
                    var showActions = (which === 'my');
                    var actions = '';
                    if (showActions && self.user && post.user_id === self.user.id) {
                        actions = '<div class="post-actions">' +
                            '<button class="btn btn-primary btn-small" onclick="app.editPost(' + post.ID + ')">âœï¸ ç¼–è¾‘</button>' +
                            '<button class="btn btn-danger btn-small" onclick="app.deletePost(' + post.ID + ')">ğŸ—‘ï¸ åˆ é™¤</button>' +
                            '</div>';
                    }

                    var preview = (post.content || '').substring(0, 140) + ((post.content || '').length > 140 ? '...' : '');
                    var commentCount = (post.comment_count !== undefined && post.comment_count !== null) ? post.comment_count : '-';
                    var badgeId = 'cmt_' + which + '_' + post.ID;

                    return '<div class="post-card">' +
                        '<div class="post-head">' +
                        '<div style="min-width:0;flex:1;">' +
                        '<h3 class="post-title" title="' + self.escapeHtml(post.title) + '" onclick="app.viewPost(' + post.ID + ')">' + `${postIndex + 1} . ` + self.escapeHtml(post.title) + '</h3>' +
                        '<div class="post-meta">' +
                        '<span class="pill">ğŸ‘¤ ' + self.escapeHtml(post.user ? post.user.username : 'æœªçŸ¥') + '</span>' +
                        '<span class="pill">ğŸ“… ' + self.escapeHtml(self.formatTime(post.CreatedAt)) + '</span>' +
                        '<span class="pill" id="' + badgeId + '">ğŸ’¬ ' + self.escapeHtml(commentCount) + '</span>' +
                        '</div>' +
                        '</div>' +
                        (actions ? actions : '') +
                        '</div>' +
                        '<div class="post-content">' + self.escapeHtml(preview) + '</div>' +
                        '</div>';
                }).join('');

                // åˆ†é¡µ
                pager.innerHTML = this.buildPaginationHtml(which, totalPages, st.page);
            },

            buildPaginationHtml: function (which, totalPages, currentPage) {
                var disabledPrev = currentPage <= 1 ? 'disabled' : '';
                var disabledNext = currentPage >= totalPages ? 'disabled' : '';

                // é¡µç æŒ‰é’®ï¼šæœ€å¤š 7 ä¸ª
                var maxBtns = 7;
                var start = Math.max(1, currentPage - Math.floor(maxBtns / 2));
                var end = Math.min(totalPages, start + maxBtns - 1);
                start = Math.max(1, end - maxBtns + 1);

                var html = '';
                html += '<button class="page-btn" ' + disabledPrev + ' onclick="app.gotoPage(\'' + which + '\',' + (currentPage - 1) + ')">ä¸Šä¸€é¡µ</button>';

                if (start > 1) {
                    html += '<button class="page-btn" onclick="app.gotoPage(\'' + which + '\',1)">1</button>';
                    if (start > 2) html += '<span class="muted" style="padding:0 4px;">â€¦</span>';
                }

                for (var i = start; i <= end; i++) {
                    html += '<button class="page-btn ' + (i === currentPage ? 'active' : '') + '" onclick="app.gotoPage(\'' + which + '\',' + i + ')">' + i + '</button>';
                }

                if (end < totalPages) {
                    if (end < totalPages - 1) html += '<span class="muted" style="padding:0 4px;">â€¦</span>';
                    html += '<button class="page-btn" onclick="app.gotoPage(\'' + which + '\',' + totalPages + ')">' + totalPages + '</button>';
                }

                html += '<button class="page-btn" ' + disabledNext + ' onclick="app.gotoPage(\'' + which + '\',' + (currentPage + 1) + ')">ä¸‹ä¸€é¡µ</button>';
                html += '<span class="muted" style="margin-left:8px;">ç¬¬ ' + currentPage + ' / ' + totalPages + ' é¡µ</span>';
                return html;
            },

            gotoPage: function (which, page) {
                if (which === 'home') {
                    this.state.home.page = page;
                    this.fetchPosts({ silent: false });
                } else {
                    this.state.my.page = page;
                    this.fetchMyPosts({ silent: false });  // â­ æ”¹ä¸ºè¯·æ±‚åç«¯
                }
                // åˆ‡é¡µæ—¶ä¸éœ€è¦å…¨å± loadingï¼Œè§†è§‰æ›´é¡ºæ»‘
            },

            // è¯„è®ºæ•°ï¼šä¼˜å…ˆä½¿ç”¨åç«¯å­—æ®µ comment_countï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯¹å½“å‰é¡µåšè½»é‡è¡¥é½
            updateCommentBadgesForList: function (which, opt) {
                var self = this;
                opt = opt || {};
                var st = (which === 'home') ? this.state.home : this.state.my;

                // ä»…è¡¥é½å½“å‰é¡µï¼ˆé¿å… n+1 è¿‡é‡ï¼‰
                var posts = st.all || [];
                if (!posts.length) return;

                var totalPages = st.totalPage || 1;
                var page = Math.min(Math.max(1, st.page), totalPages);
                var slice = posts;

                slice.forEach(function (post) {
                    if (post.comment_count !== undefined && post.comment_count !== null) return;

                    var badgeId = 'cmt_' + which + '_' + post.ID;
                    var badge = document.getElementById(badgeId);
                    if (!badge) return;

                    // é˜²é‡å¤è¯·æ±‚ï¼šæ‰“æ ‡è®°
                    if (badge.dataset.loading === '1') return;
                    badge.dataset.loading = '1';
                    badge.textContent = 'ğŸ’¬ ...';

                    self.requestJson(self.apiBase + '/comments/post/' + post.ID, {}, null)
                        .then(function (data) {
                            var count = 0;
                            if (data && data.code === 200 && Array.isArray(data.data)) count = data.data.length;
                            post.comment_count = count; // å†™å›ç¼“å­˜
                            badge.textContent = 'ğŸ’¬ ' + count;
                            badge.dataset.loading = '0';
                        })
                        .catch(function () {
                            badge.textContent = 'ğŸ’¬ -';
                            badge.dataset.loading = '0';
                        });
                });
            },

            /* ===== è¯¦æƒ…ï¼šè§£å†³â€œè¿›å…¥è¯¦æƒ…å…ˆçœ‹åˆ°ä¸Šä¸€æ¡å†…å®¹â€ ===== */
            viewPost: function (id) {
                var self = this;

                // å…ˆæ¸…ç©ºå†…å®¹ï¼Œå†è¯·æ±‚ï¼ˆé¿å…æ—§å†…å®¹æ®‹ç•™ï¼‰
                this.currentPost = null;
                document.getElementById('postDetail').innerHTML = '<div class="empty-state"><div style="font-size:38px;">â³</div><p>æ­£åœ¨åŠ è½½æ–‡ç« è¯¦æƒ…...</p></div>';
                document.getElementById('commentsList').innerHTML = '<p class="muted" style="text-align:center;">æ­£åœ¨åŠ è½½è¯„è®º...</p>';
                document.getElementById('commentContent').value = '';

                // ç›´æ¥åˆ‡åˆ°è¯¦æƒ…é¡µï¼ˆåŒæ—¶æ˜¾ç¤º loadingï¼‰
                document.querySelectorAll('.page').forEach(function (p) { p.classList.add('hidden'); });
                document.getElementById('postDetailPage').classList.remove('hidden');

                this.setLoading(true, 'æ­£åœ¨åŠ è½½æ–‡ç« è¯¦æƒ…...');
                fetch(this.apiBase + '/posts/' + id)
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.currentPost = data.data;
                            self.renderPostDetail(data.data);
                            return self.fetchComments(id);
                        } else {
                            self.showAlert('error', data.message || 'è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥');
                    })
                    .finally(function () {
                        self.setLoading(false);
                    });
            },

            renderPostDetail: function (post) {
                var container = document.getElementById('postDetail');
                container.innerHTML = '<div class="post-detail-header"><h2>' + this.escapeHtml(post.title) + '</h2>' +
                    '<div class="post-meta">' +
                    '<span class="pill">ğŸ‘¤ ' + this.escapeHtml(post.user ? post.user.username : 'æœªçŸ¥') + '</span>' +
                    '<span class="pill">ğŸ“… ' + this.escapeHtml(this.formatTime(post.CreatedAt)) + '</span>' +
                    '</div></div>' +
                    '<div class="post-content" style="line-height: 1.9; white-space: pre-wrap;">' + this.escapeHtml(post.content || '') + '</div>';

                var commentForm = document.getElementById('commentForm');
                if (this.token) {
                    commentForm.classList.remove('hidden');
                } else {
                    commentForm.classList.add('hidden');
                }
            },

            fetchComments: function (postId) {
                var self = this;
                return this.requestJson(this.apiBase + '/comments/post/' + postId, {}, null)
                    .then(function (data) {
                        if (data.code === 200) {
                            self.renderComments(data.data || []);
                        } else {
                            self.renderComments([]);
                        }
                    })
                    .catch(function (err) {
                        console.error('Fetch comments error:', err);
                        self.renderComments([]);
                    });
            },

            renderComments: function (comments) {
                var container = document.getElementById('commentsList');

                if (!comments || comments.length === 0) {
                    container.innerHTML = '<p class="muted" style="text-align: center;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§!</p>';
                    return;
                }

                container.innerHTML = comments.map(function (comment) {
                    var user = comment.user ? comment.user.username : 'æœªçŸ¥';
                    return '<div class="comment-card">' +
                        '<div class="comment-meta">ğŸ‘¤ ' + app.escapeHtml(user) + ' | ' + app.escapeHtml(app.formatTime(comment.CreatedAt)) + '</div>' +
                        '<div class="comment-content">' + app.escapeHtml(comment.content || '') + '</div>' +
                        '</div>';
                }).join('');
            },

            /* ===== æ–‡ç« æ“ä½œï¼ˆåŠ  loadingï¼Œé¿å…è§†è§‰å»¶è¿Ÿï¼‰ ===== */
            handleCreatePost: function () {
                var self = this;
                if (!this.token) {
                    this.showAlert('error', 'è¯·å…ˆç™»å½•');
                    return;
                }

                var title = document.getElementById('postTitle').value;
                var content = document.getElementById('postContent').value;

                this.requestJson(this.apiBase + '/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({ title: title, content: content })
                }, 'æ­£åœ¨å‘å¸ƒæ–‡ç« ...')
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'æ–‡ç« å‘å¸ƒæˆåŠŸ!');
                            document.getElementById('createPostForm').reset();
                            self.showPage('myPosts');
                        } else {
                            self.showAlert('error', data.message || 'å‘å¸ƒå¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'å‘å¸ƒè¯·æ±‚å¤±è´¥');
                    });
            },

            editPost: function (id) {
                var self = this;
                // å…ˆåˆ‡é¡µå¹¶æ¸…ç©ºï¼Œé¿å…æ®‹ç•™
                document.getElementById('editPostId').value = '';
                document.getElementById('editPostTitle').value = '';
                document.getElementById('editPostContent').value = '';

                document.querySelectorAll('.page').forEach(function (p) { p.classList.add('hidden'); });
                document.getElementById('editPostPage').classList.remove('hidden');

                this.requestJson(this.apiBase + '/posts/' + id, {}, 'æ­£åœ¨åŠ è½½æ–‡ç« ...')
                    .then(function (data) {
                        if (data.code === 200) {
                            document.getElementById('editPostId').value = data.data.ID;
                            document.getElementById('editPostTitle').value = data.data.title;
                            document.getElementById('editPostContent').value = data.data.content;
                        } else {
                            self.showAlert('error', data.message || 'è·å–æ–‡ç« ä¿¡æ¯å¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'è·å–æ–‡ç« ä¿¡æ¯å¤±è´¥');
                    });
            },

            handleUpdatePost: function () {
                var self = this;
                var id = document.getElementById('editPostId').value;
                var title = document.getElementById('editPostTitle').value;
                var content = document.getElementById('editPostContent').value;

                this.requestJson(this.apiBase + '/posts/' + id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({ title: title, content: content })
                }, 'æ­£åœ¨ä¿å­˜ä¿®æ”¹...')
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'æ–‡ç« æ›´æ–°æˆåŠŸ!');
                            self.showPage('myPosts');
                        } else {
                            self.showAlert('error', data.message || 'æ›´æ–°å¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'æ›´æ–°è¯·æ±‚å¤±è´¥');
                    });
            },

            deletePost: function (id) {
                var self = this;
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—?')) return;

                this.requestJson(this.apiBase + '/posts/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + this.token }
                }, 'æ­£åœ¨åˆ é™¤æ–‡ç« ...')
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'æ–‡ç« åˆ é™¤æˆåŠŸ!');
                            self.fetchMyPosts({ silent: true });
                            self.fetchPosts({ silent: true });
                        } else {
                            self.showAlert('error', data.message || 'åˆ é™¤å¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'åˆ é™¤è¯·æ±‚å¤±è´¥');
                    });
            },

            handleCreateComment: function () {
                var self = this;
                if (!this.token) {
                    this.showAlert('error', 'è¯·å…ˆç™»å½•');
                    return;
                }
                if (!this.currentPost || !this.currentPost.ID) {
                    this.showAlert('error', 'æ–‡ç« æœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
                    return;
                }

                var content = document.getElementById('commentContent').value;
                var postId = this.currentPost.ID;

                this.requestJson(this.apiBase + '/posts/' + postId + '/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({ content: content })
                }, 'æ­£åœ¨å‘è¡¨è¯„è®º...')
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'è¯„è®ºå‘è¡¨æˆåŠŸ!');
                            document.getElementById('commentContent').value = '';
                            self.fetchComments(postId).then(function () {
                                // æ›´æ–°åˆ—è¡¨ç¼“å­˜çš„è¯„è®ºæ•°
                                self.bumpCachedCommentCount(postId);
                            });
                        } else {
                            self.showAlert('error', data.message || 'è¯„è®ºå¤±è´¥');
                        }
                    })
                    .catch(function () {
                        self.showAlert('error', 'è¯„è®ºè¯·æ±‚å¤±è´¥');
                    });
            },

            bumpCachedCommentCount: function (postId) {
                // è®©é¦–é¡µ/æˆ‘çš„æ–‡ç« ä¸Šæ˜¾ç¤ºçš„è¯„è®ºæ•°+1ï¼ˆè‹¥å­˜åœ¨ï¼‰
                var lists = [this.state.home.all, this.state.my.all];
                lists.forEach(function (arr) {
                    if (!arr) return;
                    arr.forEach(function (p) {
                        if (p.ID === postId && typeof p.comment_count === 'number') p.comment_count += 1;
                    });
                });

                // åŒæ­¥å½“å‰å¯è§å¾½ç« 
                ['home', 'my'].forEach(function (which) {
                    var badge = document.getElementById('cmt_' + which + '_' + postId);
                    if (badge) {
                        var txt = badge.textContent.replace('ğŸ’¬', '').trim();
                        var n = parseInt(txt, 10);
                        if (!isNaN(n)) badge.textContent = 'ğŸ’¬ ' + (n + 1);
                    }
                });
            },

            /* ===== APIæµ‹è¯•ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰ ===== */
            addTestResult: function (message, success) {
                var results = document.getElementById('testResults');
                var div = document.createElement('div');
                div.className = 'test-item test-' + (success ? 'success' : 'error');
                div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
                results.insertBefore(div, results.firstChild);
            },

            clearTestResults: function () {
                document.getElementById('testResults').innerHTML = '<p style="color: #8c8c8c;">æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>';
            },

            testHealth: function () {
                var self = this;
                this.addTestResult('å¼€å§‹å¥åº·æ£€æŸ¥æµ‹è¯•...', true);

                fetch('http://localhost:8080/health')
                    .then(function (res) {
                        if (res.ok) {
                            self.addTestResult('âœ” å¥åº·æ£€æŸ¥é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— å¥åº·æ£€æŸ¥å¤±è´¥', false);
                        }
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— å¥åº·æ£€æŸ¥é”™è¯¯: ' + err.message, false);
                    });
            },

            testAuth: function () {
                var self = this;
                this.addTestResult('å¼€å§‹è®¤è¯æµ‹è¯•...', true);

                var testUser = {
                    username: 'test_' + Date.now(),
                    email: 'test_' + Date.now() + '@example.com',
                    password: 'test123456'
                };

                fetch(this.apiBase + '/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testUser)
                })
                    .then(function (res) { return res.json(); })
                    .then(function (regData) {
                        if (regData.code === 200) {
                            self.addTestResult('âœ” æ³¨å†Œæµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/auth/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: testUser.username,
                                    password: testUser.password
                                })
                            });
                        } else {
                            self.addTestResult('âœ— æ³¨å†Œæµ‹è¯•å¤±è´¥', false);
                            throw new Error('Registration failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (loginData) {
                        if (loginData.code === 200 && loginData.data.token) {
                            self.addTestResult('âœ” ç™»å½•æµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/profile', {
                                headers: { 'Authorization': 'Bearer ' + loginData.data.token }
                            });
                        } else {
                            self.addTestResult('âœ— ç™»å½•æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Login failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (profileData) {
                        if (profileData.code === 200) {
                            self.addTestResult('âœ” è·å–ç”¨æˆ·ä¿¡æ¯æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— è·å–ç”¨æˆ·ä¿¡æ¯æµ‹è¯•å¤±è´¥', false);
                        }
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— è®¤è¯æµ‹è¯•é”™è¯¯: ' + err.message, false);
                    });
            },

            testPosts: function () {
                var self = this;
                if (!this.token) {
                    this.addTestResult('âœ— è¯·å…ˆç™»å½•åå†æµ‹è¯•æ–‡ç« åŠŸèƒ½', false);
                    return;
                }

                this.addTestResult('å¼€å§‹æ–‡ç« æµ‹è¯•...', true);

                var postData = {
                    title: 'æµ‹è¯•æ–‡ç«  ' + Date.now(),
                    content: 'è¿™æ˜¯ä¸€ç¯‡æµ‹è¯•æ–‡ç« çš„å†…å®¹'
                };

                var postId;

                fetch(this.apiBase + '/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify(postData)
                })
                    .then(function (res) { return res.json(); })
                    .then(function (createData) {
                        if (createData.code === 200) {
                            self.addTestResult('âœ” åˆ›å»ºæ–‡ç« æµ‹è¯•é€šè¿‡', true);
                            postId = createData.data.ID;

                            return fetch(self.apiBase + '/posts/' + postId);
                        } else {
                            self.addTestResult('âœ— åˆ›å»ºæ–‡ç« æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Create post failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (getData) {
                        if (getData.code === 200) {
                            self.addTestResult('âœ” è·å–æ–‡ç« è¯¦æƒ…æµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/posts/' + postId, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + self.token
                                },
                                body: JSON.stringify({
                                    title: 'æ›´æ–°åçš„æ ‡é¢˜',
                                    content: 'æ›´æ–°åçš„å†…å®¹'
                                })
                            });
                        } else {
                            self.addTestResult('âœ— è·å–æ–‡ç« è¯¦æƒ…æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Get post failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (updateData) {
                        if (updateData.code === 200) {
                            self.addTestResult('âœ” æ›´æ–°æ–‡ç« æµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/posts/' + postId, {
                                method: 'DELETE',
                                headers: { 'Authorization': 'Bearer ' + self.token }
                            });
                        } else {
                            self.addTestResult('âœ— æ›´æ–°æ–‡ç« æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Update post failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (deleteData) {
                        if (deleteData.code === 200) {
                            self.addTestResult('âœ” åˆ é™¤æ–‡ç« æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— åˆ é™¤æ–‡ç« æµ‹è¯•å¤±è´¥', false);
                        }

                        return fetch(self.apiBase + '/posts');
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (listData) {
                        if (listData.code === 200) {
                            self.addTestResult('âœ” è·å–æ–‡ç« åˆ—è¡¨æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— è·å–æ–‡ç« åˆ—è¡¨æµ‹è¯•å¤±è´¥', false);
                        }
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— æ–‡ç« æµ‹è¯•é”™è¯¯: ' + err.message, false);
                    });
            },

            testComments: function () {
                var self = this;
                if (!this.token) {
                    this.addTestResult('âœ— è¯·å…ˆç™»å½•åå†æµ‹è¯•è¯„è®ºåŠŸèƒ½', false);
                    return;
                }

                this.addTestResult('å¼€å§‹è¯„è®ºæµ‹è¯•...', true);

                var postId;

                fetch(this.apiBase + '/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({
                        title: 'æµ‹è¯•è¯„è®ºæ–‡ç« ',
                        content: 'ç”¨äºæµ‹è¯•è¯„è®ºåŠŸèƒ½'
                    })
                })
                    .then(function (res) { return res.json(); })
                    .then(function (postData) {
                        if (postData.code === 200) {
                            postId = postData.data.ID;

                            return fetch(self.apiBase + '/posts/' + postId + '/comments', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + self.token
                                },
                                body: JSON.stringify({
                                    content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®º'
                                })
                            });
                        } else {
                            throw new Error('Create post for comments failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (commentData) {
                        if (commentData.code === 200) {
                            self.addTestResult('âœ” åˆ›å»ºè¯„è®ºæµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/comments/post/' + postId);
                        } else {
                            self.addTestResult('âœ— åˆ›å»ºè¯„è®ºæµ‹è¯•å¤±è´¥', false);
                            throw new Error('Create comment failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (getCommentsData) {
                        if (getCommentsData.code === 200) {
                            self.addTestResult('âœ” è·å–è¯„è®ºåˆ—è¡¨æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— è·å–è¯„è®ºåˆ—è¡¨æµ‹è¯•å¤±è´¥', false);
                        }

                        return fetch(self.apiBase + '/posts/' + postId, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + self.token }
                        });
                    })
                    .then(function () {
                        // Cleanup done
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— è¯„è®ºæµ‹è¯•é”™è¯¯: ' + err.message, false);
                    });
            },

            runAllTests: function () {
                var self = this;
                this.clearTestResults();
                this.addTestResult('=== å¼€å§‹è¿è¡Œå…¨éƒ¨æµ‹è¯• ===', true);

                this.testHealth();

                setTimeout(function () {
                    self.testAuth();
                }, 1000);

                setTimeout(function () {
                    self.testPosts();
                }, 2000);

                setTimeout(function () {
                    self.testComments();
                }, 3000);

                setTimeout(function () {
                    self.addTestResult('=== å…¨éƒ¨æµ‹è¯•å®Œæˆ ===', true);
                }, 5000);
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            app.init();
        });
    </script>
</body>

</html>
